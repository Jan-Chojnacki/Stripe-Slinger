services:
  init-sockets:
    image: busybox:1.36
    container_name: init-sockets
    user: "0:0"
    volumes:
      - metrics-sockets:/sockets
      - ./scripts/init-sockets.sh:/usr/local/bin/init-sockets.sh:ro
    command: ["/bin/sh", "/usr/local/bin/init-sockets.sh"]
    restart: "no"

  metrics-gateway:
    image: metrics-gateway:latest
    container_name: metrics-gateway
    build:
      context: ..
      dockerfile: services/metrics-gateway/Dockerfile
    depends_on:
      init-sockets:
        condition: service_completed_successfully
    user: "65532:65532"
    env_file:
      - ../.env
    environment:
      - GRPC_AUTH_ENABLED=true
      - GRPC_SOCKET_PATH=/sockets/metrics-gateway.sock
      - GRPC_SOCKET_MODE=0660
      - METRICS_HTTP_ADDR=:8080
    volumes:
      - metrics-sockets:/sockets
    restart: unless-stopped

  raid-simulator:
    image: raid-simulator:latest
    container_name: raid-simulator
    build:
      context: ..
      dockerfile: services/raid-simulator/Dockerfile
    depends_on:
      - metrics-gateway
    devices:
      - /dev/fuse:/dev/fuse
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    security_opt:
      - apparmor:unconfined
    env_file:
      - ../.env
    environment:
      - METRICS_SOCKET_PATH=/sockets/metrics-gateway.sock
      - RAID_LEVEL=${RAID_LEVEL:-raid3}
      - DISK_SIZE=${DISK_SIZE:-100000000}
    volumes:
      - metrics-sockets:/sockets
      - ../storage/raid-disks:/disks
      - ../storage/raid-mount:/mnt/raid
    ports:
      - "2049:2049"
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    container_name: cadvisor
    privileged: true
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    command:
      - --docker_only=true
      - --disable_metrics=disk,diskIO,referenced_memory,memory_numa,process
    restart: unless-stopped

  grafana-alloy:
    image: grafana/alloy:latest
    container_name: grafana-alloy
    env_file:
      - ../.env
    volumes:
      - ../observability/alloy/config.alloy:/etc/alloy/config.alloy:ro
      - ../storage/alloy-data:/var/lib/alloy
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
    restart: unless-stopped

volumes:
  metrics-sockets:
