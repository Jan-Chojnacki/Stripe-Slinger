raid-simulator-image:
  stage: build & push
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    IMAGE_NAME: "raid-simulator"
    DOCKER_BUILD_CONTEXT: "."
    DOCKERFILE_PATH: "services/raid-simulator/Dockerfile"
  before_script: []
  script:
    - .gitlab/ci/shared/scripts/docker-build-and-push.sh
  rules:
    - !reference [.rules-docker-build-and-push, rules]

metrics-gateway-image:
  stage: build & push
  image: docker:25
  services:
    - name: docker:25-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    IMAGE_NAME: "metrics-gateway"
    DOCKER_BUILD_CONTEXT: "."
    DOCKERFILE_PATH: "services/metrics-gateway/Dockerfile"
  before_script: []
  script:
    - .gitlab/ci/shared/scripts/docker-build-and-push.sh
  rules:
    - !reference [.rules-docker-build-and-push-go, rules]

release:
  stage: release
  image: alpine:3.20
  needs:
    - raid-simulator-image
    - metrics-gateway-image
  script:
    - .gitlab/ci/shared/scripts/release-from-tag.sh
  rules:
    - !reference [.rules-tag-only, rules]
